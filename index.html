<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rat Furniture</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>

    <nav>
        <div class="brand">Rat Furniture</div>
        <div id="admin-badge" style="display:none; font-size:0.7rem; background:black; color:white; padding:4px 8px; border-radius:4px;">ADMIN</div>
    </nav>

    <section class="hero">
        <h1>High-quality furniture<br>& aesthetics</h1>
        <p>Curated minimalist pieces for the modern home. Browse our latest collection below.</p>
        <a href="#catalog" class="hero-btn">Browse Products</a>
    </section>

    <div class="container" id="catalog">
        <div class="section-title">Latest Collection</div>
        
        <div id="grid" class="grid">
            <div class="loading">Loading Collection...</div>
        </div>
    </div>

    <button class="fab" onclick="addItem()">+</button>
    <div class="footer" onclick="toggleAdmin()">
        <span id="lock-text">ðŸ”’ Admin Access</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // --- âš ï¸ PASTE YOUR CONFIG HERE âš ï¸ ---
        const firebaseConfig = {
            apiKey: "PASTE_HERE",
            authDomain: "PASTE_HERE",
            projectId: "PASTE_HERE",
            storageBucket: "PASTE_HERE",
            messagingSenderId: "PASTE_HERE",
            appId: "PASTE_HERE"
        };
        // ------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const docRef = doc(db, "catalog", "main");
        
        let products = [];
        let isAdmin = false;
        const PASSKEY = "29876104";

        onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
                products = snap.data().products || [];
                render();
            } else {
                products = [{ name: "Modern Chair", price: "120", img: "" }];
                save();
            }
        });

        function render() {
            const grid = document.getElementById("grid");
            const badge = document.getElementById("admin-badge");
            const lockText = document.getElementById("lock-text");

            grid.innerHTML = "";
            document.body.classList.toggle('admin-mode', isAdmin);
            badge.style.display = isAdmin ? 'block' : 'none';
            lockText.innerText = isAdmin ? "Tap to Exit" : "ðŸ”’ Admin Access";

            if (products.length === 0) grid.innerHTML = '<div class="loading">No products found.</div>';

            products.forEach((p, i) => {
                const imgUrl = p.img || 'https://placehold.co/400x400/F3F3F3/CCCCCC?text=No+Img';
                
                const html = `
                <div class="card">
                    <div class="image-container">
                        <img src="${imgUrl}" id="img-${i}">
                    </div>

                    <div class="details">
                        <div class="view-content" ${isAdmin ? 'style="display:none"' : ''}>
                            <span class="category-label">FURNITURE</span>
                            <div class="item-name">${p.name}</div>
                            <div class="item-price">$${p.price}</div>
                            <a href="https://wa.me/?text=I'm interested in ${encodeURIComponent(p.name)}" 
                               style="display:block; margin-top:8px; font-size:0.8rem; text-decoration:underline; color:#111;">
                               Order via WhatsApp
                            </a>
                        </div>

                        <div class="admin-overlay">
                            <input class="admin-input" id="name-${i}" value="${p.name}" placeholder="Name">
                            <input class="admin-input" id="price-${i}" value="${p.price}" placeholder="Price">
                            
                            <label style="font-size:0.7rem; display:block; margin-bottom:5px; color:blue;">
                                ðŸ“· Change Image
                                <input type="file" style="display:none" onchange="uploadFile(this, ${i})">
                            </label>
                            <span id="status-${i}" style="font-size:0.7rem; color:green;"></span>

                            <div class="action-row">
                                <button class="btn-act btn-save" id="save-${i}" onclick="saveItem(${i})">Save</button>
                                <button class="btn-act btn-del" onclick="delItem(${i})">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                grid.innerHTML += html;
            });
        }

        window.uploadFile = async (input, index) => {
            const file = input.files[0];
            if (!file) return;
            const status = document.getElementById(`status-${index}`);
            const saveBtn = document.getElementById(`save-${index}`);
            
            status.innerText = "Uploading...";
            saveBtn.disabled = true;

            try {
                const refLink = ref(storage, 'items/' + Date.now() + '-' + file.name);
                await uploadBytes(refLink, file);
                const url = await getDownloadURL(refLink);
                
                products[index].img = url; // Update data array directly
                document.getElementById(`img-${index}`).src = url;
                status.innerText = "Done! Click Save.";
            } catch (e) {
                status.innerText = "Error!";
                console.error(e);
            }
            saveBtn.disabled = false;
        };

        window.saveItem = async (i) => {
            products[i].name = document.getElementById(`name-${i}`).value;
            products[i].price = document.getElementById(`price-${i}`).value;
            // Image is already updated in array by uploadFile
            await save();
            alert("Saved");
        };

        window.addItem = async () => {
            products.push({ name: "New Item", price: "0", img: "" });
            await save();
        };

        window.delItem = async (i) => {
            if(confirm("Delete?")) {
                products.splice(i, 1);
                await save();
            }
        };

        window.toggleAdmin = () => {
            if(!isAdmin) {
                if(prompt("Passkey") === PASSKEY) isAdmin = true;
            } else {
                isAdmin = false;
            }
            render();
        };

        async function save() {
            await setDoc(docRef, { products }, { merge: true });
        }
    </script>
</body>
</html>
